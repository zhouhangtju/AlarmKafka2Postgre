# 安全接内网原始告警

## 1.功能介绍

对接kafka内网告警数据按天存入postgresql中

## 2.主要接口和项目结构说明

```
src
└── main
    ├── java
    │   └── com.mobile.outalarm2
    │       ├── common          # 公共工具/枚举
    │       ├── dao             # 数据访问层（MyBatis Mapper接口）
    │       │   ├── AlarmResultAlldayDao # 全天告警结果的数据访问接口
    │       │   └── AlarmResultDao       # 单条告警结果的数据访问接口
    │       ├── db              # 数据库实体类
    │       ├── kafka           # Kafka消息组件
    │       │   └── KafkaConsumer # 消费告警相关消息的Kafka消费者类（核心代码）
    │       ├── task            # 定时任务
    │       │   └── TaskService # 定时执行数据表的创建和删除的定时任务类
    │       ├── util            # 工具类
    │       │   ├── DbUtil       # 数据库操作辅助工具
    │       │   └── MyStringUtils # 字符串处理工具
    │       └── OutAlarm2Application # 项目启动类，用于初始化并启动Spring Boot应用
    └── resources
        ├── mapper              # MyBatis SQL映射文件（与dao层接口对应）
        │   ├── AlarmResultAlldayDao.xml # 对应AlarmResultAlldayDao的SQL语句
        │   └── AlarmResultDao.xml       # 对应AlarmResultDao的SQL语句
        ├── application*.yml    # 环境配置文件（主配置、开发/生产/测试环境的差异化配置）
        └── logback.xml         # Logback日志框架配置
```

核心代码 位于KafkaConsumer下，这段代码是一个 Kafka 消费者方法，以 6 个并发消费指定主题的消息，将其中设备类型为 Nsfocus_FLOW_DCN 的消息解析后按创建时间的日期分组，批量插入到对应日期后缀的告警数据库表中。

```
    @KafkaListener(topics = TOPIC_TEST, concurrency = "6")
    @Transactional
    public void topic_alarm(List<String> messages, Acknowledgment ack) {
        log.info("获取到kakfa消息条数{},线程{}", messages.size(), Thread.currentThread().getName());
        // System.out.printf("获取到kakfa消息条数");
        Optional message = Optional.ofNullable(messages);

        SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");
        sdf.setTimeZone(TimeZone.getTimeZone("Asia/Shanghai")); // 设置为东八区
        Map<String, List<AlarmResultDB>> dateGroupMap = new HashMap<>();
        try {
            if (message.isPresent()) {
                String tableDs = null;
                //  log.info("获取到kakfa消息条数{}", messages.size());
                for (int i = 0; i < messages.size(); i++) {
                    AlarmResult alarm = JSON.parseObject(messages.get(i), AlarmResult.class);
                    if ("Nsfocus_FLOW_DCN".equals(alarm.getDeviceType())) {
                        String dateHourPart = alarm.getCreateTime().substring(0, 13);
                        // 去除所有非数字字符，得到 "2025082516"
                        String ds = dateHourPart.replaceAll("[^0-9]", "");
                        tableDs = ds.substring(0, 8);
                        AlarmResultDB resultDB = new AlarmResultDB();
                        resultDB.setCreateTime(alarm.getCreateTime());
                        resultDB.setEventName(alarm.getEventName());
                        resultDB.setDeviceType(alarm.getDeviceType());
                        resultDB.setSrcIp(MyStringUtils.removeNullByte(alarm.getSrcIp()));
                        resultDB.setDstIp(MyStringUtils.removeNullByte(alarm.getDstIp()));
                        resultDB.setPayload(MyStringUtils.removeNullByte(alarm.getPayload()));
                        resultDB.setResponseCode(MyStringUtils.removeNullByte(alarm.getResponseCode()));
                        resultDB.setResponseMessage(MyStringUtils.removeNullByte(alarm.getResponseMessage()));
                        resultDB.setRequestMessage(MyStringUtils.removeNullByte(alarm.getRequestMessage()));
                        resultDB.setRequestPayload(MyStringUtils.removeNullByte(alarm.getRequestPayload()));
                        dateGroupMap.computeIfAbsent(tableDs, k -> new ArrayList<>()).add(resultDB);
                    }
                }
                // 按日期分组批量插入
                for (Map.Entry<String, List<AlarmResultDB>> entry : dateGroupMap.entrySet()) {
                    String tableDs2 = entry.getKey();
                    List<AlarmResultDB> dataList = entry.getValue();
                    if (!dataList.isEmpty() && !StringUtils.isEmpty(tableDs)) { // 避免空表名或空数据
                        alarmResultDao.insertBatch(dataList, "alarm_" + tableDs2);
                    }
                }
            }
        } catch (Exception e) {
            log.info("消费数据故障:{}", e);
        } finally {
            ack.acknowledge();
        }
    }
```



## 3.数据库信息

```
建表语句
        CREATE TABLE IF NOT EXISTS public.alarm_result_20251020 (
                                                           id SERIAL PRIMARY KEY,
                                                           event_name varchar NULL,
                                                           create_time varchar NULL,
                                                           device_type varchar NULL,
                                                           src_ip varchar NULL,
                                                           dst_ip varchar NULL,
                                                           payload varchar NULL,
                                                           request_payload varchar NULL,
                                                           request_message varchar NULL,
                                                           response_code varchar NULL,
                                                           response_message varchar NULL,
                                                           is_true_attack varchar NULL
        )
```

## 4.服务器配置信息

```
188.107.240.98

1.pgsql数据映射目录
/data/outalarm/pgsqldata

docker run --name pgsql -p 5432:5432 -e POSTGRES_PASSWORD=QWER@1234 -v /data/outalarm/pgsqldata:/var/lib/postgresql/data --restart=always -d postgres:15.14-trixie

docker exec -it pgsql /bin/bash
psql -U postgres -d postgres
SET search_path TO public;

2.java全局环境 jdk8
/data/jdk

3.kafka
/data/kafka

```

